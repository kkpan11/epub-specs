<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><title>EPUB Canonical Fragment Identifiers 1.1</title><link rel="stylesheet" type="text/css" href="../../css/epub-spec-2016.css"/><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"/><meta name="description" content="This specification defines a standardized method for referencing arbitrary content within an EPUB Publication through the use of fragment identifiers."/><meta charset="utf-8"/><link rel="stylesheet" href="../../css/epub-print.css" type="text/css" media="print"/></head><body><header><p><a href="http://www.idpf.org"><img src="../../images/idpflogo_web_125.jpg" class="logo" alt="IDPF"/></a></p><h1 class="title">EPUB Canonical Fragment Identifiers 1.1</h1><p class="identity"><span class="releaseinfo">Recommended Specification</span> <span class="pubdate">5 January 2017</span></p><dl class="printhistory"><dt>This version</dt><dd><a href="http://www.idpf.org/epub/linking/cfi/epub-cfi-20170105.html">http://www.idpf.org/epub/linking/cfi/epub-cfi-20170105.html</a></dd><dt>Latest version</dt><dd><a href="http://www.idpf.org/epub/linking/cfi/epub-cfi.html">http://www.idpf.org/epub/linking/cfi/epub-cfi.html</a></dd><dt>Previous version</dt><dd><a href="http://www.idpf.org/epub/linking/cfi/epub-cfi-20161130.html">http://www.idpf.org/epub/linking/cfi/epub-cfi-20161130.html</a></dd><dt>Previous recommendation</dt><dd><a href="http://www.idpf.org/epub/linking/cfi/epub-cfi-20140628.html">http://www.idpf.org/epub/linking/cfi/epub-cfi-20140628.html</a></dd></dl><div class="history"><span class="history-title">Document history</span><ul><li><a href="https://github.com/IDPF/epub-revision/commits/master/src/spec/epub-cfi.xml">Changes to this document</a></li><li><a href="https://github.com/IDPF/epub-revision/issues?q=milestone%3A%22EPUB+3.1%22+is%3Aclosed+label%3ASpec-CFI">Issues addressed in this revision</a></li><li><a href="https://github.com/IDPF/epub-revision/issues">Report an issue</a></li><li><a href="./epub-cfi-errata/">Errata</a></li></ul></div><div class="authorgroup"><p class="bridgehead">Editors</p><p class="editor">Peter Sorotokin, 
          
            Adobe
          
        </p><p class="editor">Garth Conboy, 
          
            Google Inc.
          
        </p><p class="editor">Brady Duga, 
          
            Google Inc.
          
        </p><p class="editor">John Rivlin, 
          
            Google Inc.
          
        </p><p class="editor">Don Beaver, 
          
            Apple Inc.
          
        </p><p class="editor">Kevin Ballard, 
          
            Apple Inc.
          
        </p><p class="editor">Alastair Fettes, 
          
            Apple Inc.
          
        </p><p class="editor">Daniel Weck, 
          
            DAISY Consortium
          
        </p></div><div class="legalnotice"><p>Copyright © 
      2011
      International Digital Publishing Forum™
    </p><div xmlns:spec="http://www.idpf.org/2016/epub/spec" xml:lang="en" class="legalnotice">
    <p>All rights reserved. This work is protected under Title 17 of the United States Code.
        Reproduction and dissemination of this work with changes is prohibited except with the
        written permission of the <a href="http://www.idpf.org">International Digital
        Publishing Forum (IDPF)</a>.</p>
    <p>EPUB is a registered trademark of the International Digital Publishing Forum.</p>
</div></div></header><section id="sotd"><h2>Status of this Document</h2><p>This section describes the status of this document at the time of its publication. Other documents might supersede
        this document.</p><p>This document was produced by the EPUB Working Group under the <a class="ulink" href="http://www.idpf.org/charters/2015/epub/" target="_top">EPUB Working Group Charter</a> approved on 8 July
        2015.</p><p>This document has been reviewed by the IDPF membership and is endorsed by the IDPF Board as a Recommended
        Specification. This document is considered stable and can be referenced from other specifications and
        documents.</p><p>Feedback on this document can be provided to the EPUB Working Group's <a class="ulink" href="/cdn-cgi/l/email-protection#fd988d889fd08a928f9694939ad09a8f92888dbd9a92929a91989a8f92888d8ed39e9290" target="_top">mailing list</a> or <a class="ulink" href="https://github.com/IDPF/epub-revision" target="_top">issue tracker</a>.</p><p>This document is governed by the <a class="ulink" href="http://idpf.org/about_us/corp_docs/policies_and_procedures" target="_top">IDPF
            Policies and Procedures</a>.</p></section><nav xmlns:spec="http://www.idpf.org/2016/epub/spec" class="toc" id="toc"><h2 class="toc-title">Table of Contents</h2><ol class="toc"><li><span class="chapter"><a href="#sec-overview">1. Overview</a></span><ol><li><span class="section"><a href="#sec-overview-purpose-and-scope">1.1. Purpose and Scope</a></span></li><li><span class="section"><a href="#sec-terminology">1.2. Terminology</a></span></li><li><span class="section"><a href="#sec-typography">1.3. Typographic Conventions</a></span></li><li><span class="section"><a href="#sec-conformance-statements">1.4. Conformance Statements</a></span></li></ol></li><li><span class="chapter"><a href="#sec-epubcfi-def">2. EPUB CFI Definition</a></span><ol><li><span class="section"><a href="#sec-epubcfi-intro">2.1. Introduction</a></span></li><li><span class="section"><a href="#sec-epubcfi-syntax">2.2. Syntax</a></span></li><li><span class="section"><a href="#sec-epubcfi-escaping">2.3. Character Escaping</a></span></li></ol></li><li><span class="chapter"><a href="#sec-epubcfi-processing">3. EPUB CFI Processing</a></span><ol><li><span class="section"><a href="#sec-path-res">3.1. Path Resolution</a></span><ol><li><span class="section"><a href="#sec-path-child-ref">3.1.1. Step Reference to Child Element or Character Data (<code class="literal">/</code>)</a></span></li><li><span class="section"><a href="#sec-path-xmlid">3.1.2. XML ID Assertion (<code class="literal">[</code>)</a></span></li><li><span class="section"><a href="#sec-path-indirection">3.1.3. Step Indirection (<code class="literal">!</code>)</a></span></li><li><span class="section"><a href="#sec-path-terminating-char">3.1.4. Character Offset (<code class="literal">:</code>)</a></span></li><li><span class="section"><a href="#sec-path-terminating-temporal">3.1.5. Temporal Offset (<code class="literal">~</code>)</a></span></li><li><span class="section"><a href="#sec-path-terminating-spatial">3.1.6. Spatial Offset (<code class="literal">@</code>)</a></span></li><li><span class="section"><a href="#sec-path-terminating-tempspatial">3.1.7. Temporal-Spatial Offset (<code class="literal">~</code> + <code class="literal">@</code>)</a></span></li><li><span class="section"><a href="#sec-path-text-location">3.1.8. Text Location Assertion (<code class="literal">[</code>)</a></span></li><li><span class="section"><a href="#sec-path-side-bias">3.1.9. Side Bias (<code class="literal">[</code> + <code class="literal">;s=</code>)</a></span></li><li><span class="section"><a href="#sec-path-examples">3.1.10. Examples</a></span></li></ol></li><li><span class="section"><a href="#sec-sorting">3.2. Sorting Rules</a></span></li><li><span class="section"><a href="#sec-intra-cfis">3.3. Intra-Publication CFIs</a></span></li><li><span class="section"><a href="#sec-ranges">3.4. Simple Ranges</a></span></li><li><span class="section"><a href="#sec-target-correction">3.5. Intended Target Location Correction</a></span></li></ol></li><li><span class="chapter"><a href="#sec-extensions">4. Extending EPUB CFIs</a></span></li><li><span class="bibliography"><a href="#references">References</a></span></li></ol></nav>
  
  

  

  <section class="chapter" id="sec-overview"><h1 class="title"><span class="link-marker"><a class="hidden-reveal" href="#sec-overview"> </a> </span>1 Overview</h1>
    
    <section class="section" id="sec-overview-purpose-and-scope"><h2 class="title" style="clear: both"><span class="link-marker"><a class="hidden-reveal" href="#sec-overview-purpose-and-scope"> </a> </span>1.1 Purpose and Scope</h2><p class="informative"> This section is informative</p>
      
      <p id="sibling-specs">This specification, EPUB Canonical Fragment Identifier (epubcfi), defines a standardized
        method for referencing arbitrary content within an EPUB® Publication through the use of fragment identifiers. </p>
      <p>The Web has proven that the concept of hyperlinking is tremendously powerful, but EPUB Publications have been
        denied much of the benefit that hyperlinking makes possible because of the lack of a standardized scheme to link into
        them. Although proprietary schemes have been developed and implemented for individual Reading Systems, without a
        commonly-understood syntax there has been no way to achieve cross-platform interoperability. The functionality that
        can see significant benefit from breaking down this barrier, however, is varied: from reading location maintenance to
        annotation attachment to navigation, the ability to point into any Publication opens a whole new dimension not
        previously available to developers and Authors. </p>
      <p>This specification attempts to rectify this situation by defining an arbitrary structural reference that can
        uniquely identify any location, or simple range of locations, in an EPUB Publication: the EPUB CFI. The following
        considerations have strongly influenced the design and scope of this scheme:</p>
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
          <p>The mechanism used to reference content should be interoperable: references to a reading position created by
            one Reading System should be usable by another.</p>
        </li><li class="listitem">
          <p>Document references to EPUB content should be enabled in the same way that existing hyperlinks enable
            references throughout the Web.</p>
        </li><li class="listitem">
          <p>Each location in an EPUB file should be able to be identified without the need to modify the document.</p>
        </li><li class="listitem">
          <p>All fragment identifiers that reference the same logical location should be equal when compared.</p>
        </li><li class="listitem">
          <p>Comparison operations, including tests for sorting and comparison, should be able to be performed without
            accessing the referenced files.</p>
        </li><li class="listitem">
          <p>Simple manipulations should be possible without access to the original files (e.g., given a reference deep in
            a file, it should be possible to generate a reference to the start of the file).</p>
        </li><li class="listitem">
          <p>Identifier resolution should be reasonably efficient (e.g., processing of the first chapter is not necessary
            to resolve a fragment identifier that points to the last chapter).</p>
        </li><li class="listitem">
          <p>References should be able to recover their target locations through parser variations and document
            revisions.</p>
        </li><li class="listitem">
          <p>Expression of simple, contiguous ranges should be supported.</p>
        </li><li class="listitem">
          <p>An extensible mechanism to accommodate future reference recovery heuristics should be provided.</p>
        </li></ul></div>
      <p>In the case of both <a class="glossterm" href="#gloss-cfi-pub" title="Standard EPUB CFI">Standard EPUB CFIs</a> and <a class="glossterm" href="#gloss-cfi-intra-pub" title="Intra-Publication EPUB CFI">Intra-Publication EPUB CFI</a>, this specification conforms with the guidelines
        expressed by W3C in <a class="ulink" href="https://www.w3.org/TR/fragid-best-practices/#structures" target="_top">Section 6. Best
          Practices for Fragid Structures</a>
        <a class="biblioref" href="#refFragIDBP" title="Best Practices for Fragment Identifiers and Media Type Definitions">[<abbr class="abbrev">FragIDBestPractices</abbr>]</a>.</p>
      <p>In other words, both standard CFI URIs (e.g., "<code class="uri">book.epub#epubcfi(…)</code>", referred media type "<code class="media-type">application/epub+zip</code>") and intra-publication CFI URIs (e.g.,
          "<code class="uri">package.opf#epubcfi(…)</code>", referred media type "<code class="media-type">application/oebps-package+xml</code>") make use of a fragment identifier syntax that does not overlap with
        existing schemes in the context of the aforementioned media types' suffix registrations (i.e.,
        "<code class="markup">-xml</code>" and "<code class="markup">-zip</code>"). </p>
    </section>
    <section class="section" id="sec-terminology"><h2 class="title" style="clear: both"><span class="link-marker"><a class="hidden-reveal" href="#sec-terminology"> </a> </span>1.2 Terminology</h2>
      
      <p>
        <span class="emphasis"><em>Please refer to <a class="biblioref" href="#refEPUB3" title="EPUB 3.1">[<abbr class="abbrev">EPUB 3.1</abbr>]</a> for definitions of EPUB-specific terminology used in this
          document.</em></span>
      </p>
      <div class="glosslist"><dl><dt class="glossentry" id="gloss-cfi-pub"><span class="glossterm">Standard EPUB CFI</span></dt><dd class="glossdef"><p>A publication-level EPUB CFI links into an EPUB Publication. The path preceding the EPUB CFI references the
              location of the EPUB Publication.</p></dd><dt class="glossentry" id="gloss-cfi-intra-pub"><span class="glossterm">Intra-Publication EPUB CFI</span></dt><dd class="glossdef"><p>An intra-publication EPUB CFI allows one Content Document to reference another within the same Rendition of
              an EPUB Publication. The path preceding the EPUB CFI references the current Rendition's Package
              Document.</p><p>Refer to <a class="xref" href="#sec-intra-cfis" title="3.3 Intra-Publication CFIs">Intra-Publication CFIs</a>
               for more
              information. </p></dd></dl></div>
    </section>
    <section xml:lang="en" class="section" id="sec-typography"><h2 class="title" style="clear: both"><span class="link-marker"><a class="hidden-reveal" href="#sec-typography"> </a> </span>1.3 Typographic Conventions</h2>
    

    <p>The following typographic conventions are used in this specification:</p>
    <div class="variablelist"><dl class="variablelist"><dt class="varlistentry"><span class="term"><code class="markup">markup</code></span></dt><dd>
                <p>All markup (elements, attributes, properties), code (JavaScript, pseudo-code), machine-readable values
                    (string, characters, media types) and file names are in red monospace font.</p>
            </dd><dt class="varlistentry"><span class="term"><code class="code-link">markup link</code></span></dt><dd>
                <p>Links to markup and code definitions are in underlined red monospace font.</p>
            </dd><dt class="varlistentry"><span class="term"><code class="uri">http://www.idpf.org/</code></span></dt><dd>
                <p>URIs are in navy blue monospace font.</p>
            </dd><dt class="varlistentry"><span class="term"><span class="link">hyperlink</span></span></dt><dd>
                <p>Hyperlinks are underlined and blue.</p>
            </dd><dt class="varlistentry"><span class="term"><span class="link-ref">[reference]</span></span></dt><dd>
                <p>Normative and informative references are enclosed in square brackets.</p>
            </dd><dt class="varlistentry"><span class="term"><span class="terminology">Term</span></span></dt><dd>
                <p>Terms defined in the <a class="xref" href="#sec-terminology" title="1.2 Terminology">Terminology</a> are in capital case.</p>
            </dd><dt class="varlistentry"><span class="term"><span class="link-def">Term Link</span></span></dt><dd>
                <p>Links to term definitions have a dotted blue underline.</p>
            </dd></dl></div>
    <div class="elem-synopsis"><dl class="elem-synopsis"><dt class="varlistentry"><span class="term"/></dt><dd>
                <p>Normative element, attribute and property definitions are in blue boxes.</p>
            </dd></dl></div>
    <div class="informalexample">
        <pre class="synopsis">Informative markup examples are in light gray boxes.</pre>
    </div>
    <div class="note"><h3 class="title">note</h3>
        <p>Informative notes are in green boxes with a "Note" header.</p>
    </div>
    <div class="caution"><h3 class="title">caution</h3>
        <p>Informative cautionary notes are in red boxes with a "Caution" header.</p>
    </div>
</section>
    <section xml:lang="en" class="section" id="sec-conformance-statements"><h2 class="title" style="clear: both"><span class="link-marker"><a class="hidden-reveal" href="#sec-conformance-statements"> </a> </span>1.4 Conformance Statements</h2>
    
	<p>The keywords <span class="rfc2119">MUST</span>, <span class="rfc2119">MUST NOT</span>, 
		<span class="rfc2119">REQUIRED</span>, <span class="rfc2119">SHALL</span>, <span class="rfc2119">SHALL NOT</span>,
		<span class="rfc2119">SHOULD</span>, <span class="rfc2119">SHOULD NOT</span>, <span class="rfc2119">RECOMMENDED</span>,
		<span class="rfc2119">MAY</span>, and <span class="rfc2119">OPTIONAL</span> in this document are to be interpreted as
        described in <a class="biblioref" href="#refRFC2119" title="Key words for use in RFCs to Indicate Requirement Levels (RFC 2119)">[<abbr class="abbrev">RFC2119</abbr>]</a>.</p>
    <p>All sections and appendixes of this specification are normative except where identified by 
        the informative status label "This section is informative". The application of informative 
        status to sections and appendixes applies to all child content and subsections 
        they contain.</p>
    <p>All examples in this specification are informative.</p>
</section>
  </section>
  <section class="chapter" id="sec-epubcfi-def"><h1 class="title"><span class="link-marker"><a class="hidden-reveal" href="#sec-epubcfi-def"> </a> </span>2 EPUB CFI Definition</h1>
    
    <section class="section" id="sec-epubcfi-intro"><h2 class="title" style="clear: both"><span class="link-marker"><a class="hidden-reveal" href="#sec-epubcfi-intro"> </a> </span>2.1 Introduction</h2><p class="informative"> This section is informative</p>
      
      <p>A fragment identifier is the part of an IRI <a class="biblioref" href="#refRFC3987" title="Internationalized Resource Identifiers (IRIs) (RFC 3987)">[<abbr class="abbrev">RFC3987</abbr>]</a> that defines a location within a
        resource. Syntactically, it is the segment attached to the end of the resource IRI starting with a hash
          (<code class="literal">#</code>). For HTML documents, IDs and named anchors are used as fragment identifiers, while for XML
        documents the Shorthand XPointer <a class="biblioref" href="#refXPTRSH" title="XPointer Shorthand Notation">[<abbr class="abbrev">XPTRSH</abbr>]</a> notation is used to refer to a given ID.</p>
      <p>A Canonical Fragment Identifier (CFI) is a similar construct to these, but expresses a location within an EPUB
        Publication. For example:</p>
      <div class="informalexample">
        <pre class="synopsis">book.epub#epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/3:10)</pre>
      </div>
      <p>The function-like string immediately following the hash (<code class="markup">epubcfi(…)</code>) indicates that this
        fragment identifier conforms to the scheme defined by this specification, and the value contained in the parentheses
        is the syntax used to reference the location within the specified EPUB Publication (<code class="filename">book.epub</code>).
        Using the processing rules defined in <a class="xref" href="#sec-path-res" title="3.1 Path Resolution">Path Resolution</a>, any Reading System can parse this syntax, open
        the corresponding Content Document in the EPUB Publication and load the specified location for the user.</p>
      <p>A complete definition of the EPUB CFI syntax is provided in the next section.</p>
      <div class="note"><h3 class="title">note</h3>
        <p><code class="markup">epub</code> has been prepended to the name of the scheme, as a more generic CFI-like scheme might be
          defined in the future for all XML+ZIP-based file formats.</p>
      </div>
    </section>
    <section class="section" id="sec-epubcfi-syntax"><h2 class="title" style="clear: both"><span class="link-marker"><a class="hidden-reveal" href="#sec-epubcfi-syntax"> </a> </span>2.2 Syntax</h2>
      
      <table xmlns:spec="http://www.idpf.org/2016/epub/spec" style="width: 100%; border-spacing: 0; border-collapse: collapse;" class="productionset"><caption>(EBNF productions <a href="http://www.iso.org/iso/iso_catalogue/catalogue_tc/catalogue_detail.htm?csnumber=26153">ISO/IEC 14977</a>)<br/>All terminal symbols are in the Unicode Block 'Basic Latin' (U+0000 to U+007F).</caption><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.fragment"><a href="#epubcfi.ebnf.fragment">fragment</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> "epubcfi(" , ( <a href="#epubcfi.ebnf.path">path</a> , [ <a href="#epubcfi.ebnf.range">range</a> ] ) , ")" ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.path"><a href="#epubcfi.ebnf.path">path</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top">
            <a href="#epubcfi.ebnf.step">step</a> , <a href="#epubcfi.ebnf.local_path">local_path</a>
          ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.range"><a href="#epubcfi.ebnf.range">range</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> "," , <a href="#epubcfi.ebnf.local_path">local_path</a> , "," , <a href="#epubcfi.ebnf.local_path">local_path</a>
          ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.local_path"><a href="#epubcfi.ebnf.local_path">local_path</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> { <a href="#epubcfi.ebnf.step">step</a> } , ( <a href="#epubcfi.ebnf.redirected_path">redirected_path</a> | [ <a href="#epubcfi.ebnf.offset">offset</a> ] );</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.redirected_path"><a href="#epubcfi.ebnf.redirected_path">redirected_path</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> "!" , ( <a href="#epubcfi.ebnf.offset">offset</a> | <a href="#epubcfi.ebnf.path">path</a> );</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.step"><a href="#epubcfi.ebnf.step">step</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> "/" , <a href="#epubcfi.ebnf.integer">integer</a> , [ "[" , <a href="#epubcfi.ebnf.assertion">assertion</a> , "]" ] ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.offset"><a href="#epubcfi.ebnf.offset">offset</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> ( ( ":" , <a href="#epubcfi.ebnf.integer">integer</a> ) | ( "@" , <a href="#epubcfi.ebnf.number">number</a> , ":" , <a href="#epubcfi.ebnf.number">number</a> ) | ( "~" , <a href="#epubcfi.ebnf.number">number</a> , [ "@" ,
              <a href="#epubcfi.ebnf.number">number</a> , ":" , <a href="#epubcfi.ebnf.number">number</a> ] ) ) , [ "[" , <a href="#epubcfi.ebnf.assertion">assertion</a> , "]"
            ] ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.number"><a href="#epubcfi.ebnf.number">number</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> ( <a href="#epubcfi.ebnf.digit-non-zero">digit-non-zero</a> , { <a href="#epubcfi.ebnf.digit">digit</a> } , [ "." , { <a href="#epubcfi.ebnf.digit">digit</a> } , <a href="#epubcfi.ebnf.digit-non-zero">digit-non-zero</a> ] ) | (
              <a href="#epubcfi.ebnf.zero">zero</a> , [ "." , { <a href="#epubcfi.ebnf.digit">digit</a> } , <a href="#epubcfi.ebnf.digit-non-zero">digit-non-zero</a> ] )
          ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.integer"><a href="#epubcfi.ebnf.integer">integer</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top">
            <a href="#epubcfi.ebnf.zero">zero</a> | ( <a href="#epubcfi.ebnf.digit-non-zero">digit-non-zero</a> , { <a href="#epubcfi.ebnf.digit">digit</a> } ) ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.assertion"><a href="#epubcfi.ebnf.assertion">assertion</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> ( ( <a href="#epubcfi.ebnf.value">value</a> , [ "," , <a href="#epubcfi.ebnf.value">value</a> ] ) | ( "," , <a href="#epubcfi.ebnf.value">value</a> ) | ( <a href="#epubcfi.ebnf.parameter">parameter</a> ) ) {
              <a href="#epubcfi.ebnf.parameter">parameter</a> } ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.parameter"><a href="#epubcfi.ebnf.parameter">parameter</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> ";" , <a href="#epubcfi.ebnf.value-no-space">value-no-space</a> , "=" , <a href="#epubcfi.ebnf.csv">csv</a>
          ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.csv"><a href="#epubcfi.ebnf.csv">csv</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top">
            <a href="#epubcfi.ebnf.value">value</a> , { "," , <a href="#epubcfi.ebnf.value">value</a> } ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.value"><a href="#epubcfi.ebnf.value">value</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top">
            <a href="#epubcfi.ebnf.string-escaped-special-chars">string-escaped-special-chars</a>
          ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.value-no-space"><a href="#epubcfi.ebnf.value-no-space">value-no-space</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top">
            <a href="#epubcfi.ebnf.value">value</a> - ( [ <a href="#epubcfi.ebnf.value">value</a> ] , <a href="#epubcfi.ebnf.space">space</a> , [ <a href="#epubcfi.ebnf.value">value</a> ] ) ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.special-chars"><a href="#epubcfi.ebnf.special-chars">special-chars</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"><a href="#epubcfi.ebnf.circumflex">circumflex</a> | <a href="#epubcfi.ebnf.square-brackets">square-brackets</a> | <a href="#epubcfi.ebnf.parentheses">parentheses</a> | <a href="#epubcfi.ebnf.comma">comma</a> | <a href="#epubcfi.ebnf.semicolon">semicolon</a> | <a href="#epubcfi.ebnf.equal">equal</a>
          ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.escaped-special-chars"><a href="#epubcfi.ebnf.escaped-special-chars">escaped-special-chars</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> ( <a href="#epubcfi.ebnf.circumflex">circumflex</a> , <a href="#epubcfi.ebnf.circumflex">circumflex</a> ) | ( <a href="#epubcfi.ebnf.circumflex">circumflex</a> , <a href="#epubcfi.ebnf.square-brackets">square-brackets</a> ) |
            ( <a href="#epubcfi.ebnf.circumflex">circumflex</a> , <a href="#epubcfi.ebnf.parentheses">parentheses</a> ) | ( <a href="#epubcfi.ebnf.circumflex">circumflex</a> , <a href="#epubcfi.ebnf.comma">comma</a> ) | ( <a href="#epubcfi.ebnf.circumflex">circumflex</a> , <a href="#epubcfi.ebnf.semicolon">semicolon</a> ) | ( <a href="#epubcfi.ebnf.circumflex">circumflex</a> ,
              <a href="#epubcfi.ebnf.equal">equal</a> ) ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.character-escaped-special"><a href="#epubcfi.ebnf.character-escaped-special">character-escaped-special</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> ( <a href="#epubcfi.ebnf.character">character</a> - <a href="#epubcfi.ebnf.special-chars">special-chars</a> ) | <a href="#epubcfi.ebnf.escaped-special-chars">escaped-special-chars</a>
          ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.string-escaped-special-chars"><a href="#epubcfi.ebnf.string-escaped-special-chars">string-escaped-special-chars</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top">
            <a href="#epubcfi.ebnf.character-escaped-special">character-escaped-special</a> , {
              <a href="#epubcfi.ebnf.character-escaped-special">character-escaped-special</a> } ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.digit"><a href="#epubcfi.ebnf.digit">digit</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top">
            <a href="#epubcfi.ebnf.zero">zero</a> | <a href="#epubcfi.ebnf.digit-non-zero">digit-non-zero</a>
          ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.digit-non-zero"><a href="#epubcfi.ebnf.digit-non-zero">digit-non-zero</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> "1" | "2" | "3" | "4" | "5" | "6" | "7" | "8" | "9" ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.zero"><a href="#epubcfi.ebnf.zero">zero</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> "0" ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.space"><a href="#epubcfi.ebnf.space">space</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> " " ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.circumflex"><a href="#epubcfi.ebnf.circumflex">circumflex</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> "^" ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.square-brackets"><a href="#epubcfi.ebnf.square-brackets">square-brackets</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> "[" | "]" ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.parentheses"><a href="#epubcfi.ebnf.parentheses">parentheses</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> "(" | ")" ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.comma"><a href="#epubcfi.ebnf.comma">comma</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> "," ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.semicolon"><a href="#epubcfi.ebnf.semicolon">semicolon</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> ";" ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.equal"><a href="#epubcfi.ebnf.equal">equal</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> "=" ;</td><td style="vertical-align: top; text-align: left;"> </td></tr><tr><td style="text-align: right; vertical-align: top;" id="epubcfi.ebnf.character"><a href="#epubcfi.ebnf.character">character</a></td><td style="vertical-align: top; text-align: center;"><code>=</code></td><td style="vertical-align: top"> ? Unicode Characters ? 
          ;</td><td style="vertical-align: top; text-align: left;"> </td></tr></table>
      <div class="constraintdef" id="unicode-chars"><span class="link-marker"><a class="hidden-reveal" href="#unicode-chars"> </a> </span>
        <p><strong>Unicode Characters</strong></p>
        <p> The definition of allowed Unicode characters is the same as <a class="biblioref" href="#refXML" title="Extensible Markup Language (XML) 1.0 (Fifth Edition)">[<abbr class="abbrev">XML</abbr>]</a>. This excludes the
          surrogate blocks, FFFE, and FFFF: </p>
        <pre class="programlisting">

#x9 | #xA | #xD | [#x20-#xD7FF] | [#xE000-#xFFFD] | [#x10000-#x10FFFF]
</pre>
        <p>Document authors are encouraged to avoid "compatibility characters", as defined in section 2.3 of <a class="biblioref" href="#refUnicode5" title="The Unicode Consortium. The Unicode Standard.">[<abbr class="abbrev">Unicode</abbr>]</a>. The characters defined in the following ranges are also discouraged. They are either
          control characters or permanently undefined Unicode characters:</p>
        <pre class="programlisting">

[#x7F-#x84], [#x86-#x9F], [#xFDD0-#xFDEF],
[#x1FFFE-#x1FFFF], [#x2FFFE-#x2FFFF], [#x3FFFE-#x3FFFF],
[#x4FFFE-#x4FFFF], [#x5FFFE-#x5FFFF], [#x6FFFE-#x6FFFF],
[#x7FFFE-#x7FFFF], [#x8FFFE-#x8FFFF], [#x9FFFE-#x9FFFF],
[#xAFFFE-#xAFFFF], [#xBFFFE-#xBFFFF], [#xCFFFE-#xCFFFF],
[#xDFFFE-#xDFFFF], [#xEFFFE-#xEFFFF], [#xFFFFE-#xFFFFF],
[#x10FFFE-#x10FFFF].
</pre>
      </div>
      
      
      
      
      
      
      
      
      
      <p>A Canonical Fragment Identifier (CFI) consists of an initial sequence <code class="markup">epubcfi</code> that identifies
        this particular reference method, and a parenthesized path or range. A path is built up as a sequence of structural
        steps to reference a location. A range is a path followed by two local (or relative) paths that identify the start
        and end of the range.</p>
      <p>Steps are denoted by the forward slash character (<code class="literal">/</code>), and are used to traverse XML content.
        The last step in a CFI path represents a location within a document, either structural (XML element), textual
        (character data), or aural-visual (image, audio, or video media). Such terminating steps <span class="rfc2119">may</span> be complemented by an <span class="rfc2119">optional</span> "offset", which denotes a
        particular character position, temporal or spatial fragment.</p>
      <p>Substrings in brackets are extensible assertions that improve the robustness of traversing paths and migrating
        them from one revision of the document to another. These assertions preserve additional information about traversed
        elements of the document, which makes it possible to recover intended location even after some modifications are made
        to the EPUB Publication.</p>
      <p>Although the <span class="strong"><strong>value</strong></span> definition in the syntax above allows any a sequence of
        characters, a circumflex (<code class="literal">^</code>) <span class="rfc2119">must</span> be used to escape the
        following characters to ensure their presence does not interfere with parsing:</p>
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
          <p>brackets (<code class="literal">[</code>,<code class="literal">]</code>)</p>
        </li><li class="listitem">
          <p>circumflex (<code class="literal">^</code>)</p>
        </li><li class="listitem">
          <p>comma (<code class="literal">,</code>)</p>
        </li><li class="listitem">
          <p>parentheses (<code class="literal">(</code>,<code class="literal">)</code>)</p>
        </li><li class="listitem">
          <p>semicolon (<code class="literal">;</code>)</p>
        </li></ul></div>
      <div class="informalexample">
        <p>Example of an EPUB CFI that points to a location after the text "<code class="literal">2[1]</code>".</p>
        <pre class="synopsis">epubcfi(/6/14[chap05ref]!/4[body01]/10/2/1:3[2^[1^]])</pre>
      </div>
      <p>The following rules apply to the use of numbers and integers within the path or range:</p>
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
          <p>leading zeros are not allowed for numbers or integers (to ensure uniqueness);</p>
        </li><li class="listitem">
          <p>trailing zeros are not allowed in the fractional part of a number;</p>
        </li><li class="listitem">
          <p>zero <span class="rfc2119">must</span> be represented as the integer <code class="literal">0</code>;</p>
        </li><li class="listitem">
          <p>numbers in the range <code class="literal">1 &gt; N &gt; 0</code>
            <span class="rfc2119">must</span> have a leading <code class="literal">0.</code>;</p>
        </li><li class="listitem">
          <p>integral numbers <span class="rfc2119">must</span> be represented as integers.</p>
        </li></ul></div>
    </section>
    <section class="section" id="sec-epubcfi-escaping"><h2 class="title" style="clear: both"><span class="link-marker"><a class="hidden-reveal" href="#sec-epubcfi-escaping"> </a> </span>2.3 Character Escaping</h2>
      
      <p> As described in <a class="xref" href="#sec-epubcfi-syntax" title="2.2 Syntax">Syntax</a>, the EPUB CFI grammar contains characters that have a
        special purpose as delimiters within a fragment identifier expression. These characters <span class="rfc2119">must</span> be escaped using the circumflex '<code class="literal">^</code>' character when not intended for use as
        delimiters, so that they can appear within the EPUB CFI data without being mistaken for delimiters. Depending on the
        usage context of such EPUB CFI, further character escaping <span class="rfc2119">may</span> be necessary in
        order to ensure that all potentially-conflicting text tokens are encoded correctly. </p>
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
          <div class="itemizedlist"><p>IRI and URI references:</p><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
              <p> The EPUB CFI (fragment identifier) scheme is designed to be used within URI and IRI references. The
                  <a class="biblioref" href="#refRFC3986" title="Uniform Resource Identifier (URI): Generic Syntax (RFC 3986)">[<abbr class="abbrev">RFC3986</abbr>]</a> specification defines a number of "reserved" characters that have a specific
                purpose as delimiters, and which <span class="rfc2119">may</span> need to be escaped in cases when they
                would otherwise conflict with the syntactical structure of the URI/IRI reference. The character used for
                escaping is the percent sign '<code class="literal">%</code>', and escapable characters get percent-encoded. For
                example, the percent character itself becomes "<code class="literal">%25</code>" when it gets escaped (note the
                difference with EPUB CFI's circumflex '<code class="literal">^</code>', which gets escaped using a double character
                  '<code class="literal">^^</code>').</p>
            </li><li class="listitem">
              <p> Unlike IRI references, URI references require unicode characters to be ASCII-encoded. Although the EPUB
                specification itself is based on IRIs (i.e. authors and production tools are expected to use IRIs), some
                systems or APIs might only support URIs. As a result, implementors <span class="rfc2119">may</span>
                still need too handle the conversion of IRI to URI references, as defined in <a class="biblioref" href="#refRFC3987" title="Internationalized Resource Identifiers (IRIs) (RFC 3987)">[<abbr class="abbrev">RFC3987</abbr>]</a>.
                Disallowed characters are escaped as follows: </p>
              <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem">
                  <p> Each disallowed character is converted to UTF-8 <a class="biblioref" href="#refRFC2279" title="UTF-8, a transformation format of ISO 10646 (RFC 2279)">[<abbr class="abbrev">RFC2279</abbr>]</a> as one or more bytes.
                    The disallowed characters in URI references include all non-ASCII characters, plus the excluded
                    characters listed in Section 2.4 of <a class="biblioref" href="#refRFC2396" title="Uniform Resource Identifiers (URI): Generic Syntax (RFC 2396)">[<abbr class="abbrev">RFC2396</abbr>]</a>, except for the number sign
                      '<code class="literal">#</code>' and percent sign '<code class="literal">%</code>' and the square bracket characters
                    re-allowed in <a class="biblioref" href="#refRFC2732" title="Format for Literal IPv6 Addresses in URL's (RFC 2732)">[<abbr class="abbrev">RFC2732</abbr>]</a>.</p>
                  <p> The resulting bytes are escaped with the URI escaping mechanism (that is, converted to
                      '<code class="literal">%HH</code>', where HH is the hexadecimal notation of the byte value). </p>
                  <p> The original character is replaced by the resulting character sequence. </p>
                </li></ul></div>
            </li></ul></div>
        </li><li class="listitem">
          <p>(X)HTML context:</p>
          <p> IRI references are designed to be used in the various types of documents that EPUB Publications comprise.
            XML and (X)HTML represent yet another insertion context that requires specific character escaping rules. For
            example, double quote characters or angle brackets conflict with significant delimiters in the markup syntax, and
              <span class="rfc2119">must</span> therefore be escaped using the <code class="literal">&amp;xxx;</code> special
            sequence (character reference).</p>
        </li></ul></div>
      <p> When multiple layers of character escaping are applied to escape or unescape an EPUB CFI, they <span class="rfc2119">must</span> be applied in reverse order to revert back to the original form. For example, [
        EPUB-CFI -&gt; IRI -&gt; (X)HTML ] becomes [ (X)HTML -&gt; IRI -&gt; EPUB-CFI ] </p>
      <div class="informalexample">
        <p>The following example shows an EPUB CFI in its "raw" form (only with '<code class="literal">^</code>' circumflex
          escaping). Note the assertion text at the end of it, with escaped square brackets as well as the escaped circumflex
          character itself (the unescaped text is 'Ф-"spa ce"-99%-aa[bb]^'):</p>
        <pre class="synopsis">epubcfi(/6/4!/4/10/2/1:3[Ф-"spa ce"-99%-aa^[bb^]^^])</pre>
      </div>
      <div class="informalexample">
        <p>When taking part in an IRI, the space character within the assertion might become percent-escaped
            ('<code class="literal">%20</code>'), and the percent character itself <span class="rfc2119">must</span> be escaped
            ('<code class="literal">%25</code>'). Note that the square brackets '<code class="literal">[</code>' '<code class="literal">]</code>' and
          semicolumn '<code class="literal">:</code>' are "reserved" characters (as per the URI specification) but because they serve
          no purpose as delimiters when the IRI processor extracts the fragment identifier, they do not need to be escaped
          (i.e. the fragment component of the IRI can non-ambiguously be parsed by processing all the text after the
            '<code class="literal">#</code>' character). The circumflex '<code class="literal">^</code>' also falls within the category of
          "unwise" (or "unsafe") characters, but the EPUB fragment identifier scheme does not require escaping them. Here is
          the IRI-escaped EPUB CFI:</p>
        <pre class="synopsis">#epubcfi(/6/4!/4/10/2/1:3[Ф-"spa%20ce"-99%25-aa^[bb^]^^])</pre>
      </div>
      <div class="informalexample">
        <p>When the IRI appears within an XML attribute, the double quote character (quotation mark) is significant as a
          delimiter of the attribute value, so it becomes escaped with '<code class="literal">&amp;#x22;</code>'. Note that the
          Cyrillic "EF" character ('Ф') is directly supported in EPUB XML documents (which use the UTF-8 encoding to
          represent the unicode character repertoire), so it doesn't need to be encoded:</p>
        <pre class="synopsis">#epubcfi(/6/4!/4/10/2/1:3[Ф-&amp;#x22;spa%20ce&amp;#x22;-99%25-aa^[bb^]^^])</pre>
      </div>
      <div class="informalexample">
        <p>If the IRI need to be converted to URI, the non-ASCII Cyrillic "EF" character ('Ф') would get percent-escaped
          with 2 bytes ('<code class="literal">0xd0 0xa4</code>', in hexadecimal). This would result in the following URI:</p>
        <pre class="synopsis">#epubcfi(/6/4!/4/10/2/1:3[%d0%a4-%22spa%20ce%22-99%25-aa^[bb^]^^])</pre>
        <p> URI encoding / decoding APIs usually "aggressively" percent-encode characters, as demonstrated in the
          following example. Note how the circumflexes '<code class="literal">^</code>' (%5E), square brackets '<code class="literal">[</code>'
          (%5B) '<code class="literal">]</code>' (%5D) and double-quotes '<code class="literal">"</code>' (%22) are also percent-encoded (due to
          their "unsafe" / "unwise" nature within URIs) :</p>
        <pre class="synopsis">#epubcfi(/6/4!/4/10/2/1:3%5B%D0%A4-%22spa%20ce%22-99%25-aa%5E%5Bbb%5E%5D%5E%5E%5D)</pre>
      </div>
    </section>
  </section>
  <section class="chapter" id="sec-epubcfi-processing"><h1 class="title"><span class="link-marker"><a class="hidden-reveal" href="#sec-epubcfi-processing"> </a> </span>3 EPUB CFI Processing</h1>
    
    <section class="section" id="sec-path-res"><h2 class="title" style="clear: both"><span class="link-marker"><a class="hidden-reveal" href="#sec-path-res"> </a> </span>3.1 Path Resolution</h2>
      
      <p>The process of resolving an EPUB CFI to a location within an EPUB Publication begins with the root
          <code class="markup">package</code> element of the Package Document. Each step in the CFI is then processed one by one, left
        to right, applying the rules defined in the following subsections.</p>
      <div class="note"><h3 class="title">note</h3>
        <p>The EPUB CFI examples in the following subsections are based on the sample documents in <a class="xref" href="#sec-path-examples" title="3.1.10 Examples">Examples</a>.</p>
      </div>
      <section class="section" id="sec-path-child-ref"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" href="#sec-path-child-ref"> </a> </span>3.1.1 Step Reference to Child Element or Character Data (<code class="literal">/</code>)</h3>
        

        <p>A step with a slash (<code class="literal">/</code>) followed by a positive integer refers to either a child element or a
          chunk of character data, as per the rules defined herein:</p>

        <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
            <p><a class="biblioref" href="#refXML" title="Extensible Markup Language (XML) 1.0 (Fifth Edition)">[<abbr class="abbrev">XML</abbr>]</a> content other than element and character data is ignored. Note that as per the
                <a class="biblioref" href="#refXML" title="Extensible Markup Language (XML) 1.0 (Fifth Edition)">[<abbr class="abbrev">XML</abbr>]</a> specification, character data inside CDATA sections is included, and conversely, XML
              comments are ignored.</p>
          </li><li class="listitem">
            <p><a class="biblioref" href="#refXML" title="Extensible Markup Language (XML) 1.0 (Fifth Edition)">[<abbr class="abbrev">XML</abbr>]</a> character data that corresponds to insignificant white space (typically used for
              markup formatting/indenting) is preserved. Character and entity references are considered expanded, and
              character data is obtained from the "included replacement text" (as per the terminology defined in the <a class="biblioref" href="#refXML" title="Extensible Markup Language (XML) 1.0 (Fifth Edition)">[<abbr class="abbrev">XML</abbr>]</a> specification).</p>
          </li><li class="listitem">
            <p><a class="biblioref" href="#refXML" title="Extensible Markup Language (XML) 1.0 (Fifth Edition)">[<abbr class="abbrev">XML</abbr>]</a> character data that is interspersed amongst sibling child elements (i.e., "mixed
              content" context) is logically organised into (potentially-empty) chunks of contiguous character data: the
              first chunk is located before the first child element (left sibling), the last chunk is located after the last
              child element (right sibling), and there is one chunk between each pair of child elements. When there are no
              child elements, there is one (potentially-empty) chunk of character data. Consecutive (potentially-empty)
              chunks of character data are each assigned odd indices (i.e., starting at 1, followed by 3, etc.).</p>
          </li><li class="listitem">
            <p>Child <a class="biblioref" href="#refXML" title="Extensible Markup Language (XML) 1.0 (Fifth Edition)">[<abbr class="abbrev">XML</abbr>]</a> elements are assigned even indices (i.e., starting at 2, followed by 4,
              etc.). Additionally, 0 is a valid index that refers to a non-existing element which virtually precedes the
              first potentially-empty chunk of character data within the parent element's content. Similarly,
                <code class="literal">n+2</code> is a valid index that refers to a non-existing element which virtually follows the
              last potentially-empty chunk of character data, where <code class="literal">n</code> is the even index of the last child
              element, or 0 if there are no child elements. CFI processors (e.g., Reading Systems) <span class="rfc2119">must</span> be capable of consuming (e.g., parsing and interpreting) CFI expressions containing
              references to the 0 and <code class="literal">n+2</code> "virtual" elements, even when the first (or last, respectively)
              chunk of character data is empty. Conversely, the *production* of such CFI expressions is governed by the
              following conformance requirement: if the first chunk of character data is empty, a CFI expression <span class="rfc2119">should not</span> be constructed using a reference to the "virtual" element at index 0,
              instead the "real" first child element (at index 2) <span class="rfc2119">should</span> be referred to.
              Similarly, if the last chunk of character data is empty, a CFI expression <span class="rfc2119">should
                not</span> be constructed using a reference to the "virtual" element at index <code class="literal">n+2</code>,
              instead the "real" last child element (at index <code class="literal">n</code>) <span class="rfc2119">should</span>
              be referred to.</p>
          </li></ul></div>

        <div class="note"><h3 class="title">note</h3>
          <p>The "virtual" first / last elements mechanism might facilitate interoperability with certain instances of DOM
            Ranges, whereby non-existing elements are used to span across textual content without relying on character
            offsets at the start/end boundaries.</p>
        </div>

        <p>For a <a class="glossterm" href="#gloss-cfi-pub" title="Standard EPUB CFI">Standard EPUB CFI</a>, the leading step in the CFI <span class="rfc2119">must</span> start
          with a slash (<code class="literal">/</code>) followed by an even number that references the <code class="markup">spine</code> child
          element of the Package Document's root <code class="markup">package</code> element. The Package Document traversed by the CFI
            <span class="rfc2119">must</span> be the one specified as the Default Rendition in the EPUB Publication's
            <code class="filename">META-INF/container.xml</code> file (i.e., the Package Document referenced by the first
            <code class="markup">rootfile</code> element in <code class="filename">container.xml</code>).</p>
        <p>For an <a class="glossterm" href="#gloss-cfi-intra-pub" title="Intra-Publication EPUB CFI">Intra-Publication EPUB CFI</a>, the first step <span class="rfc2119">must</span> start with
          a slash followed by a node number that references a position in Package Document starting from the root
            <code class="markup">package</code> element.</p>
      </section>
      <section class="section" id="sec-path-xmlid"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" href="#sec-path-xmlid"> </a> </span>3.1.2 XML ID Assertion (<code class="literal">[</code>)</h3>
        
        <p>When an EPUB CFI references an element that contains an ID <a class="biblioref" href="#refXML" title="Extensible Markup Language (XML) 1.0 (Fifth Edition)">[<abbr class="abbrev">XML</abbr>]</a>, the corresponding path
          step <span class="rfc2119">must</span> include that ID in square brackets (i.e., after the slash
            (<code class="literal">/</code>) and even number that identifies the element).</p>
        <p>Specification of identifiers adds robustness to the CFI scheme: a Reading System can determine that the
          location referenced by the CFI is not the original intended location, and can use the identifier to compute the set
          of steps that reach the desired destination in the content (see <a class="xref" href="#sec-target-correction" title="3.5 Intended Target Location Correction">Intended Target Location Correction</a>). The cost
          of this added robustness is that comparison (and sorting) of CFI strings can be performed only after logically
          stripping all bracketed substrings (see <a class="xref" href="#sec-sorting" title="3.2 Sorting Rules">Sorting Rules</a>).</p>
      </section>
      <section class="section" id="sec-path-indirection"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" href="#sec-path-indirection"> </a> </span>3.1.3 Step Indirection (<code class="literal">!</code>)</h3>
        
        <p>If a step, or a sequence of steps, points to an element that references another document, the exclamation mark
            (<code class="literal">!</code>) <span class="rfc2119">must</span> be used whenever that step is immediately followed
          by an expression that applies to the referenced document ("indirection"). The following expression is then resolved
          from the root element of the referenced XML document, or from the targeted XML fragment (when specified).</p>
        <p>Only the following references are honored:</p>
        <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
            <p>For <code class="markup">itemref</code> in the Package Document <code class="markup">spine</code>, the reference is defined by
              the <code class="markup">href</code> attribute of the corresponding <code class="markup">item</code> element in the
                <code class="markup">manifest</code> (i.e., that the <code class="markup">itemref</code>'s <code class="markup">idref</code> attribute
              references).</p>
          </li><li class="listitem">
            <p>For <a class="biblioref" href="#refHTML" title="HTML">[<abbr class="abbrev">HTML</abbr>]</a>
              <code class="markup"><a class="markup" href="https://www.w3.org/TR/html/semantics-embedded-content.html#the-iframe-element" target="_top">iframes</a></code> and <code class="markup"><a class="markup" href="https://www.w3.org/TR/html/semantics-embedded-content.html#the-embed-element" target="_top">embed</a></code>
              elements, references are defined by the <code class="markup">src</code> attribute</p>
          </li><li class="listitem">
            <p>For the <a class="biblioref" href="#refHTML" title="HTML">[<abbr class="abbrev">HTML</abbr>]</a>
              <code class="markup"><a class="markup" href="https://www.w3.org/TR/html/semantics-embedded-content.html#the-object-element" target="_top">object</a></code> element, the reference is defined by the <code class="markup">data</code> attribute</p>
          </li><li class="listitem">
            <p>For <a class="biblioref" href="#refSVG" title="Scalable Vector Graphics (SVG)">[<abbr class="abbrev">SVG</abbr>]</a>
              <code class="markup"><a class="markup" href="https://www.w3.org/TR/SVG/struct.html#ImageElement" target="_top">image</a></code> and <code class="markup"><a class="markup" href="https://www.w3.org/TR/SVG/struct.html#UseElement" target="_top">use</a></code> elements, references are defined
              by the <code class="markup">xlink:href</code> attribute</p>
          </li></ul></div>
        <div class="note"><h3 class="title">note</h3>
          <p>This scheme does not take into account hyperlinks, only embedding references. Consequently, it is illegal to
            follow links from the <a class="biblioref" href="#refHTML" title="HTML">[<abbr class="abbrev">HTML</abbr>]</a> (or <a class="biblioref" href="#refSVG" title="Scalable Vector Graphics (SVG)">[<abbr class="abbrev">SVG</abbr>]</a>) <code class="markup">a</code> element.</p>
        </div>
      </section>
      <section class="section" id="sec-path-terminating-char"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" href="#sec-path-terminating-char"> </a> </span>3.1.4 Character Offset (<code class="literal">:</code>)</h3>
        
        <p>A path terminating with a leading colon (<code class="literal">:</code>) followed by an integer refers to a character
          offset. The given character offset <span class="rfc2119">may</span> apply to an element only if this element
          is the <a class="biblioref" href="#refHTML" title="HTML">[<abbr class="abbrev">HTML</abbr>]</a>
          <code class="markup"><a class="markup" href="https://www.w3.org/TR/html/semantics-embedded-content.html#the-img-element" target="_top">img</a></code>
          element with an <code class="markup">alt</code> attribute containing the text to which the character offset applies.</p>


        <p>For XML character data, the offset is zero-based and always refers to a position between characters, so
            <code class="literal">0</code> means before the first character and a number equal to the total UTF-16 length means after
          the last character. A character offset value greater than the UTF-16 length of the available text <span class="rfc2119">must not</span> be specified.</p>

        <p>In this specification, the definition of an "offset" within XML character data is based on the UTF-16 text
          encoding, whereby each "character" (Unicode code point) <span class="rfc2119">may</span> be represented using
          a single 16-bit code unit, or two units (surrogate pairs, for Unicode characters outside of BMP / Basic
          Multilingual Plane) <a class="biblioref" href="#refUnicode5" title="The Unicode Consortium. The Unicode Standard.">[<abbr class="abbrev">Unicode</abbr>]</a>. A CFI "character offset" is a zero-based number that refers to a
          position between UTF-16 code units. Here, the "length" of the text is the total count of 16-bit units. Offset zero
          therefore means before the first 16-bit unit, and a number equal to the "length" of the text means after the last
          16-bit unit. An offset value greater than the "length" of the text <span class="rfc2119">must not</span> be
          specified.</p>

        <div class="note"><h3 class="title">note</h3>
          <p>Counting the number of text "characters" based on UTF-16 code units (instead of Unicode code points) is
            compatible with the <a class="ulink" href="https://www.w3.org/TR/2000/REC-DOM-Level-2-Traversal-Range-20001113/ranges.html#Level-2-Range-Position-h3" target="_top">DOM Range model</a>
            <a class="biblioref" href="#refDOM2TraversalRange" title="Document Object Model (DOM) Level 2 Traversal and Range Specification">[<abbr class="abbrev">DOM2 Traversal Range</abbr>]</a>, and with the <a class="ulink" href="http://www.ecma-international.org/ecma-262/6.0/#sec-ecmascript-language-types-string-type" target="_top">String
              API</a>
            <a class="biblioref" href="#refECMA262" title="ECMA-262 6th Edition, ECMAScript® 2015 Language Specification">[<abbr class="abbrev">ECMA-262</abbr>]</a></p>
        </div>

        <p>A character offset <span class="rfc2119">may</span> follow a <code class="literal">/N</code> step. For XHTML Content
          Documents, <code class="literal">N</code> would be an even number when referencing the <code class="markup">alt</code> text of an
            <code class="markup">img</code> element, and <code class="literal">N</code> would be odd when referencing XML character data within
          elements.</p>
        <p>CFI expressions that terminate with an odd numbered <code class="literal">/N</code> step <span class="rfc2119">should</span> include an explicit character offset. However, CFI processors (e.g., Reading Systems) <span class="rfc2119">must</span> be capable of consuming (i.e., parse + interpret / render) such CFI expressions, by
          assuming the implicit <code class="literal">/N:0</code> character offset.</p>
      </section>
      <section class="section" id="sec-path-terminating-temporal"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" href="#sec-path-terminating-temporal"> </a> </span>3.1.5 Temporal Offset (<code class="literal">~</code>)</h3>
        
        <p>A path terminating with a leading tilde (<code class="literal">~</code>) followed by a number indicates a temporal
          position for audio or video measured in seconds.</p>
      </section>
      <section class="section" id="sec-path-terminating-spatial"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" href="#sec-path-terminating-spatial"> </a> </span>3.1.6 Spatial Offset (<code class="literal">@</code>)</h3>
        
        <p>A path terminating with a leading at sign (<code class="literal">@</code>) followed by two colon-separated numbers
          indicates a 2D spatial position within an image or video. The two numbers represent scaled locations in the
            <code class="literal">x</code> and <code class="literal">y</code> axes, and <span class="rfc2119">must</span> be in the range
            <code class="literal">0</code> to <code class="literal">100</code> regardless of the image's native or display dimensions (i.e., the
          upper left is <code class="literal">0:0</code> and the lower right is <code class="literal">100:100</code>).</p>
      </section>
      <section class="section" id="sec-path-terminating-tempspatial"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" href="#sec-path-terminating-tempspatial"> </a> </span>3.1.7 Temporal-Spatial Offset (<code class="literal">~</code> + <code class="literal">@</code>)</h3>
        
        <p>A temporal and a spatial position <span class="rfc2119">may</span> be used together. In this case, the
          temporal specification <span class="rfc2119">must</span> precede the spatial one syntactically (e.g.,
            <code class="literal"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="9ae4a8a9b4afdaafb4adaf">[email&#160;protected]</a>:97.6</code> refers to a point 23.5 seconds into a video in the lower left of the
          frame).</p>
      </section>
      <section class="section" id="sec-path-text-location"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" href="#sec-path-text-location"> </a> </span>3.1.8 Text Location Assertion (<code class="literal">[</code>)</h3>
        
        <p>An EPUB CFI <span class="rfc2119">may</span> specify a substring that is expected to precede and/or follow
          the encountered point, but such assertions <span class="rfc2119">must</span> occur only after a <a class="link" href="#sec-path-terminating-char" title="3.1.4 Character Offset (:)">character offset</a>.</p>
        <p>For example, the following expression asserts that <code class="literal">yyy</code> is expected immediately before the
          encountered point using the <a class="link" href="#sec-path-examples" title="3.1.10 Examples">sample content below</a>:</p>
        <div class="informalexample">
          <pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3[yyy])</pre>
        </div>
        <p>An additional substring that follows the encountered point can be given after a comma. For example:</p>
        <div class="informalexample">
          <pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/1:3[xx,y])</pre>
        </div>
        <p>refers to the position marked by the asterisk:</p>
        <div class="informalexample">
          <pre class="synopsis">
x x x y y y 0 1 2 3 4 5 6 7 8 9
| | | * | | | | | | | | | | | |</pre>
        </div>
        <p>If there is no preceding text, or only trailing text is specified, a comma <span class="rfc2119">must</span> immediately precede the text assertion:</p>
        <div class="informalexample">
          <pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3[,y])</pre>
        </div>
        <p>There is no restriction on the amount of the preceding and following text that can be included in the match.
          Text is taken from the document ignoring element boundaries and white space is always collapsed (i.e., a non-empty
          sequence of contiguous white space characters is always replaced with a single space character).</p>
        <p>A Reading System can determine that the location referenced by the CFI is not the original intended location
          (due to non-matching text), and can use the preceding/trailing text to compute the set of steps that reach the
          desired destination in the content (see <a class="xref" href="#sec-target-correction" title="3.5 Intended Target Location Correction">Intended Target Location Correction</a>). The cost of this added robustness
          is that comparison (and sorting) of CFI strings can be performed only after logically stripping all bracketed
          substrings (see <a class="xref" href="#sec-sorting" title="3.2 Sorting Rules">Sorting Rules</a>).</p>
      </section>
      <section class="section" id="sec-path-side-bias"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" href="#sec-path-side-bias"> </a> </span>3.1.9 Side Bias (<code class="literal">[</code> + <code class="literal">;s=</code>)</h3>
        
        <p>In some situations, it is important to preserve which side of a location a reference points to. For example,
          when resolving a location in a dynamically paginated environment, it would make a difference if a location is
          attached to the content before or after it (e.g., to determine whether to display the verso or recto side at a page
          break).</p>
        <p>The <code class="literal">s</code> parameter is used to preserve this sided-ness aspect of a location. It can take two
          values: '<code class="literal">b</code>' ("before") means that the location is attached to the content that precedes
          (according to the XML serialization document order), '<code class="literal">a</code>' ("after") refers to the content that
          follows. This parameter <span class="rfc2119">must</span> always be used inside square brackets at the end of
          the CFI, even if the ID <a class="biblioref" href="#refXML" title="Extensible Markup Language (XML) 1.0 (Fifth Edition)">[<abbr class="abbrev">XML</abbr>]</a> or text location assertion is empty.</p>
        <p>The location just after <code class="literal">yyy</code> in the <a class="link" href="#sec-path-examples" title="3.1.10 Examples">sample content
            below</a> can be expressed as belonging with the content before it as follows:</p>
        <div class="informalexample">
          <pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3[;s=b])</pre>
        </div>
        <p>Equally, it can be expressed including a text location assertion as:</p>
        <div class="informalexample">
          <pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3[yyy;s=b])</pre>
        </div>
        <p>The location at the start of <code class="markup">em</code> element can be attached to the content preceding the
            <code class="markup">em</code> element as follows:</p>
        <div class="informalexample">
          <pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2[;s=b])</pre>
        </div>
        <p>If the side bias in the preceding example was set to <code class="literal">a</code> rather than <code class="literal">b</code>, the
          location would be attached to the child content of the <code class="markup">em</code> element, not the content following the
            <code class="markup">em</code> element.</p>
        <p>Since side bias is expressed as a parameter, it does not participate in CFI comparison (see <a class="xref" href="#sec-sorting" title="3.2 Sorting Rules">Sorting Rules</a>).</p>
        <p>Side is not defined for locations with spatial offset.</p>
        <div class="note"><h3 class="title">note</h3>
          <p>Side bias is only meaningful when some type of break falls at the location (e.g., a page break or line
            break).</p>
        </div>
      </section>
      <section class="section" id="sec-path-examples"><h3 class="title"><span class="link-marker"><a class="hidden-reveal" href="#sec-path-examples"> </a> </span>3.1.10 Examples</h3><p class="informative"> This section is informative</p>
        
        <p>Given the following Package Document:</p>
        <div class="informalexample">
          <pre class="synopsis">&lt;?xml version="1.0"?&gt;&#xD;
&#xD;
&lt;package version="2.0" &#xD;
         unique-identifier="bookid" &#xD;
         xmlns="http://www.idpf.org/2007/opf"&#xD;
         xmlns:dc="http://purl.org/dc/elements/1.1/" &#xD;
         xmlns:opf="http://www.idpf.org/2007/opf"&gt;&#xD;
    &#xD;
    &lt;metadata&gt;&#xD;
    	&lt;dc:title&gt;…&lt;/dc:title&gt;&#xD;
    	&lt;dc:identifier id="bookid"&gt;…&lt;/dc:identifier&gt;&#xD;
    	&lt;dc:creator&gt;…&lt;/dc:creator&gt;&#xD;
        &lt;dc:language&gt;en&lt;/dc:language&gt;&#xD;
    &lt;/metadata&gt;&#xD;
    &#xD;
    &lt;manifest&gt;&#xD;
        &lt;item id="toc"&#xD;
              properties="nav"&#xD;
              href="toc.xhtml" &#xD;
              media-type="application/xhtml+xml"/&gt;&#xD;
        &lt;item id="titlepage" &#xD;
              href="titlepage.xhtml" &#xD;
              media-type="application/xhtml+xml"/&gt;&#xD;
        &lt;item id="chapter01" &#xD;
              href="chapter01.xhtml" &#xD;
              media-type="application/xhtml+xml"/&gt;&#xD;
        &lt;item id="chapter02" &#xD;
              href="chapter02.xhtml" &#xD;
              media-type="application/xhtml+xml"/&gt;&#xD;
        &lt;item id="chapter03" &#xD;
              href="chapter03.xhtml" &#xD;
              media-type="application/xhtml+xml"/&gt;&#xD;
        &lt;item id="chapter04" &#xD;
              href="chapter04.xhtml" &#xD;
              media-type="application/xhtml+xml"/&gt;&#xD;
    &lt;/manifest&gt;&#xD;
    &#xD;
    &lt;spine&gt;&#xD;
        &lt;itemref id="titleref"  idref="titlepage"/&gt;&#xD;
        &lt;itemref id="chap01ref" idref="chapter01"/&gt;&#xD;
        &lt;itemref id="chap02ref" idref="chapter02"/&gt;&#xD;
        &lt;itemref id="chap03ref" idref="chapter03"/&gt;&#xD;
        &lt;itemref id="chap04ref" idref="chapter04"/&gt;&#xD;
    &lt;/spine&gt;&#xD;
    &#xD;
&lt;/package&gt;&#xD;
</pre>
        </div>
        <p>and the XHTML Content Document <code class="filename">chapter01.xhtml</code>:</p>
        <div class="informalexample">
          <pre class="synopsis">&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;&#xD;
    &lt;head&gt;&#xD;
    	&lt;title&gt;…&lt;/title&gt;&#xD;
    &lt;/head&gt;&#xD;
    &#xD;
    &lt;body id="body01"&gt;&#xD;
    	&lt;p&gt;…&lt;/p&gt;&#xD;
    	&lt;p&gt;…&lt;/p&gt;&#xD;
    	&lt;p&gt;…&lt;/p&gt;&#xD;
    	&lt;p&gt;…&lt;/p&gt;&#xD;
        &lt;p id="para05"&gt;xxx&lt;em&gt;yyy&lt;/em&gt;0123456789&lt;/p&gt;&#xD;
    	&lt;p&gt;…&lt;/p&gt;&#xD;
    	&lt;p&gt;…&lt;/p&gt;&#xD;
    	&lt;img id="svgimg" src="foo.svg" alt="…"/&gt;&#xD;
    	&lt;p&gt;…&lt;/p&gt;&#xD;
    	&lt;p&gt;…&lt;/p&gt;&#xD;
    &lt;/body&gt;&#xD;
&lt;/html&gt;&#xD;
</pre>
        </div>
        <p>Then the EPUB CFI:</p>
        <div class="informalexample">
          <pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/3:10)</pre>
        </div>
        <p>refers to the position right after the digit <code class="literal">9</code> in the paragraph with the ID
            <code class="literal">para05</code>. When producing CFIs for text locations, unless the text is defined by an
            <code class="markup">img</code> element's <code class="markup">alt</code> tag, one <span class="rfc2119">should</span> always
          start with the reference to the (possibly-empty) chunk of XML character data that corresponds to the location and
          then trace the ancestor and reference chain to the Package Document root.</p>
        <p>The following examples show how EPUB CFIs can be constructed to reference additional content locations.</p>
        <div class="informalexample">
          <p>Reference to the <code class="markup">img</code> element.</p>
          <pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/16[svgimg])</pre>
        </div>
        <div class="informalexample">
          <p>Reference to the location just before <code class="literal">xxx</code>.</p>
          <pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/1:0)</pre>
        </div>
        <div class="informalexample">
          <p>Reference to the location just before <code class="literal">yyy</code>.</p>
          <pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:0)</pre>
        </div>
        <div class="informalexample">
          <p>Reference to the location just after <code class="literal">yyy</code>.</p>
          <pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3)</pre>
        </div>
      </section>
    </section>
    <section class="section" id="sec-sorting"><h2 class="title" style="clear: both"><span class="link-marker"><a class="hidden-reveal" href="#sec-sorting"> </a> </span>3.2 Sorting Rules</h2>
      
      <p>In order to sort or compute relative locations of multiple EPUB CFIs referencing the same EPUB Publication, the
        following rules <span class="rfc2119">must</span> be applied:</p>
      <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
          <p> The EPUB CFI scheme data <span class="rfc2119">must</span> be in unescaped form, as per the rules
            described in <a class="xref" href="#sec-epubcfi-escaping" title="2.3 Character Escaping">Character Escaping</a>.</p>
        </li><li class="listitem">
          <p>all bracketed assertions are removed (ignored) entirely;</p>
        </li><li class="listitem">
          <p>steps that come earlier in the sequence are more important;</p>
        </li><li class="listitem">
          <p>XML elements, references to chunks of XML character data, character offsets and temporal positions are sorted
            in natural order;</p>
        </li><li class="listitem">
          <p>the <code class="literal">y</code> position is more important than <code class="literal">x</code>;</p>
        </li><li class="listitem">
          <p>omitted spatial position precedes all other spatial positions;</p>
        </li><li class="listitem">
          <p>omitted temporal position precedes all other temporal positions;</p>
        </li><li class="listitem">
          <p>temporal position is more important than spatial;</p>
        </li><li class="listitem">
          <p>different step types come in the following order from least important to most important: character offset
              (<code class="literal">:</code>), child (<code class="literal">/</code>), temporal-spatial (<code class="literal">~</code> or
              <code class="literal">@</code>), reference/indirect (<code class="literal">!</code>).</p>
        </li></ol></div>
    </section>
    <section class="section" id="sec-intra-cfis"><h2 class="title" style="clear: both"><span class="link-marker"><a class="hidden-reveal" href="#sec-intra-cfis"> </a> </span>3.3 Intra-Publication CFIs</h2>
      
      <p>An EPUB CFI can be used to reference content inside the container. This kind of referencing can be achieved by
        specifying a reference to the Package Document followed by a CFI, which <span class="rfc2119">must</span> be
        resolved starting from the root <code class="markup">package</code> element.</p>
      <p>For example, using the Package Document in the <a class="link" href="#sec-path-examples" title="3.1.10 Examples">previous example</a>, a
        reference to the last location in <code class="filename">chapter01.xhtml</code> might be written as follows:</p>
      <div class="informalexample">
        <pre class="synopsis">../pub.opf#epubcfi(/6/4[chap01ref]!/4[body01]/10[para05]/2/1:3[;s=b])</pre>
      </div>
    </section>
    <section class="section" id="sec-ranges"><h2 class="title" style="clear: both"><span class="link-marker"><a class="hidden-reveal" href="#sec-ranges"> </a> </span>3.4 Simple Ranges</h2>
      
      <p>EPUB CFIs allow the expression of simple ranges extending from a start location to an end location. A range
          <span class="rfc2119">must</span> be expressed as a triple of <span class="emphasis"><em>parent</em></span> path
          (<code class="literal">P</code>), <span class="emphasis"><em>start</em></span> subpath (<code class="literal">S</code>) and <span class="emphasis"><em>end</em></span>
        subpath (<code class="literal">E</code>), or of the form:</p>
      <div class="informalexample">
        <pre class="synopsis">epubcfi(P,S,E)</pre>
      </div>
      <p>The parent path <span class="rfc2119">must</span> not be empty, and <span class="rfc2119">must</span>
        end at a step that is common for resolving both the path of the start and end locations of the range, and each start
        and end subpath <span class="rfc2119">must</span> resolve to a location in non-decreasing order in the
        document.</p>
      <p>To determine the start and end locations of the range, the start and end subpaths <span class="rfc2119">must</span> be concatenated to the parent path to create the start location path (<code class="literal">PS</code>) and
        end location path (<code class="literal">PE</code>). The parent path <span class="rfc2119">should</span> include the
        deepest possible common path leading to both the start and end path (in other words, the start and end location
          <span class="rfc2119">should not</span> contain a common path). The start location <span class="rfc2119">may</span> be empty, to avoid repetition of a common path in cases where the end location is situated within
        the subtree rooted at the start location.</p>
      <p>Using the <a class="link" href="#sec-path-examples" title="3.1.10 Examples">sample documents above</a>, the following range would represents
        the text from the second <code class="literal">y</code> in <code class="literal">yyy</code> up to (and including) digit
          <code class="literal">3</code>:</p>
      <div class="informalexample">
        <pre class="synopsis">epubcfi(/6/4[chap01ref]!/4[body01]/10[para05],/2/1:1,/3:4)</pre>
      </div>
      <p>Ranges <span class="rfc2119">must</span> be compared according to their <code class="literal">PS</code>, then
          <code class="literal">PE</code>, components. The start and end locations <span class="rfc2119">should</span> reference
        points in the document that have the same "nature", that is to say elements and character offsets (document
        structure), temporal offsets (timed media), spatial offsets (visual media), or the combined temporal-spatial offsets.
        In the case of temporal offsets, the start and end locations <span class="rfc2119">should</span> reference the
        same timed media. In the case of spatial offsets, the start and end locations <span class="rfc2119">should</span> reference the same visual media. This specification does not define expected behaviors, such as
        how the combination of two spatial offsets (i.e., start and end locations within a visual media) is to be interpreted
        by processing agents, including production tools and reading systems.</p>
      <p>It is not valid to use a path to an element as a shorthand for the range from the beginning to the end of the
        element. Single path notation always denotes a location point, and range is represented by the notation described
        above. There is no special step to produce a reference to the end of an element, as that would make sorting
        impossible without consulting the content of the document.</p>
      <p>If range is used where single location is expected by the context, the start location <span class="rfc2119">must</span> be used.</p>
      <p>Side-bias parameters <span class="rfc2119">must not</span> be used for ranges; the start of a range is
        implicitly attached to the content after the start location and the end is implicitly attached to the content before
        the end location.</p>
    </section>
    <section class="section" id="sec-target-correction"><h2 class="title" style="clear: both"><span class="link-marker"><a class="hidden-reveal" href="#sec-target-correction"> </a> </span>3.5 Intended Target Location Correction</h2>
      
      <p>As an EPUB Publication can be updated, corrected or otherwise altered over time, it is useful to be able to
        derive an EPUB CFI for the modified document from one that targeted a previous version. This specification provides
        two mechanisms to detect and adapt to content changes that impact CFIs: IDs <a class="biblioref" href="#refXML" title="Extensible Markup Language (XML) 1.0 (Fifth Edition)">[<abbr class="abbrev">XML</abbr>]</a> and <a class="link" href="#sec-path-text-location" title="3.1.8 Text Location Assertion ([)">text location assertions</a>.</p>
      <p>When a Reading System is processing a CFI, it <span class="rfc2119">should</span> check the correctness of
        any encountered assertions. For example, given the path <code class="literal">/6/4[chap01ref]!…</code>, the Reading System
          <span class="rfc2119">should</span> verify that the element has the ID matching <code class="literal">chap01ref</code>
        when processing element <code class="literal">4</code> (for this example, an <code class="markup">itemref</code> in the
          <code class="markup">spine</code>). If not, the Reading System <span class="rfc2119">should</span> locate the ID
          <code class="literal">chap01ref</code> within the document and correct the CFI (e.g., if a new <code class="markup">itemref</code> was
        inserted before the <code class="literal">chap01ref</code>
        <code class="markup">itemref</code>, the desired element number would now be <code class="literal">6</code> and the corrected CFI would be
          <code class="literal">/6/6[chap01ref]!…</code>). Likewise, text location assertions <span class="rfc2119">should</span>
        be used to check referenced target locations, and used to derive a corrected CFI that targets the desired text
        location.</p>
      <p>If one of the assertions fails during processing, and a corrected CFI can not be derived (the ID is not found in
        the document, or text matches could not be found), the CFI <span class="rfc2119">must</span> be considered an
        invalid reference. In cases where a Reading System cannot check for correctness (e.g., document-resident XML IDs are
        not available at CFI processing time), a Reading System <span class="rfc2119">must</span> ignore the CFI
        assertions.</p>
      <p>This notion of correcting CFIs can lead to circumstances where two different CFIs point to the same location
        (i.e., the "stale" CFI, pre-correction, and the corrected CFI). The corrected CFI <span class="rfc2119">should</span> be used where possible. A Reading System and any surrounding content management system <span class="rfc2119">should</span> attempt to replace stale CFIs with their corrected versions where possible.</p>
      <div class="note"><h3 class="title">note</h3>
        <p>This specification encourages the development of custom functions to assist with CFI correction where the
          intrinsic functionality is insufficient. Refer to <a class="xref" href="#sec-extensions" title="4 Extending EPUB CFIs"><em>Extending EPUB CFIs</em></a> for more information on how to
          develop such functionality.</p>
      </div>
    </section>
  </section>
  <section class="chapter" id="sec-extensions"><h1 class="title"><span class="link-marker"><a class="hidden-reveal" href="#sec-extensions"> </a> </span>4 Extending EPUB CFIs</h1>
    
    <p>The provision for extensions (CSV parameter lists, prefixed by a parameter name, and separated by semicolons) allow
      Reading Systems to apply new or experimental heuristics to assist, for example, in migrating EPUB CFI fragments to
      updated documents.</p>
    <p>It is <span class="rfc2119">recommended</span> that any vendor-specific parameter names start with
        <code class="literal">vnd.</code> followed by the vendor name.</p>
    <p>Implementations <span class="rfc2119">must</span> ignore all parameters that they do not understand or cannot
      parse.</p>
  </section>
  <section xmlns:spec="http://www.idpf.org/2016/epub/spec" xml:lang="en" class="bibliography" id="references"><div class="titlepage"><div><div><h1 class="title"><span class="link-marker"><a class="hidden-reveal" href="#references"> </a> </span>References</h1></div></div></div>
  
  
  
<div class="bibliodiv" id="normative-refs">
    <h3 class="title">Normative References</h3>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
  <div class="biblioentry" id="refEPUB3"><p>[<abbr class="abbrev">EPUB 3.1</abbr>] 
      
      <span class="title"><em>
        <a class="ulink" href="../../31/spec/epub-spec.html" target="_top">EPUB 3.1</a>
      </em>. </span>
    </p></div><div class="biblioentry" id="refEPUBCFI"><p>[<abbr class="abbrev">EPUB-CFI</abbr>] 
      
      <span class="title"><em>
        <a class="ulink" href="http://www.idpf.org/epub/linking/cfi/epub-cfi.html" target="_top">EPUB Canonical Fragment Identifier (epubcfi)
          Specification</a>
      </em>. </span>
    </p></div><div class="biblioentry" id="refHTML"><p>[<abbr class="abbrev">HTML</abbr>] 
      
      <span class="title"><em>
        <a class="ulink" href="https://www.w3.org/TR/html/" target="_top">HTML</a>
      </em>. </span>
    </p></div><div class="biblioentry" id="refRFC2119"><p>[<abbr class="abbrev">RFC2119</abbr>] 
      
      <span class="title"><em>
        <a class="ulink" href="http://tools.ietf.org/html/rfc2119" target="_top">Key words for use in RFCs to Indicate Requirement Levels</a>
        (RFC 2119) </em>. </span>
      <span class="date">March 1997. </span>
    </p></div><div class="biblioentry" id="refRFC2279"><p>[<abbr class="abbrev">RFC2279</abbr>] 
      
      <span class="title"><em>
        <a class="ulink" href="http://tools.ietf.org/html/rfc2279" target="_top"> UTF-8, a transformation format of ISO 10646 </a> (RFC 2279) </em>. </span>
      <span class="author">F. Yergeau, et al. </span>
      <span class="date">January 1998. </span>
    </p></div><div class="biblioentry" id="refRFC2396"><p>[<abbr class="abbrev">RFC2396</abbr>] 
      
      <span class="title"><em>
        <a class="ulink" href="http://tools.ietf.org/html/rfc2396" target="_top"> Uniform Resource Identifiers (URI): Generic Syntax </a>
        (RFC 2396) </em>. </span>
      <span class="author">T. Berners-Lee, et al. </span>
      <span class="date">August 1998. </span>
    </p></div><div class="biblioentry" id="refRFC2732"><p>[<abbr class="abbrev">RFC2732</abbr>] 
      
      <span class="title"><em>
        <a class="ulink" href="http://tools.ietf.org/html/rfc2732" target="_top"> Format for Literal IPv6 Addresses in URL's </a> (RFC 2732) </em>. </span>
      <span class="author">R. Hinden, et al. </span>
      <span class="date">December 1999. </span>
    </p></div><div class="biblioentry" id="refRFC3986"><p>[<abbr class="abbrev">RFC3986</abbr>] 
      
      <span class="title"><em>
        <a class="ulink" href="http://tools.ietf.org/html/rfc3986" target="_top">Uniform Resource Identifier (URI): Generic Syntax</a> (RFC
        3986) </em>. </span>
      <span class="author">Berners-Lee, et al. </span>
      <span class="date">January 2005. </span>
    </p></div><div class="biblioentry" id="refRFC3987"><p>[<abbr class="abbrev">RFC3987</abbr>] 
      
      <span class="title"><em>
        <a class="ulink" href="http://tools.ietf.org/html/rfc3987" target="_top">Internationalized Resource Identifiers (IRIs)</a> (RFC 3987) </em>. </span>
      <span class="author">M Duerst, et al. </span>
      <span class="date">January 2005. </span>
    </p></div><div class="biblioentry" id="refSVG"><p>[<abbr class="abbrev">SVG</abbr>] 
      
      <span class="title"><em>
        <a class="ulink" href="https://www.w3.org/TR/SVG/" target="_top">Scalable Vector Graphics (SVG)</a>
      </em>. </span>
    </p></div><div class="biblioentry" id="refUnicode5"><p>[<abbr class="abbrev">Unicode</abbr>] 
      
      <span class="title"><em> The Unicode Consortium. <a class="ulink" href="http://www.unicode.org/versions/latest/" target="_top">The Unicode
        Standard.</a></em>. </span>
    </p></div><div class="biblioentry" id="refXML"><p>[<abbr class="abbrev">XML</abbr>] 
      
      <span class="title"><em>
        <a class="ulink" href="https://www.w3.org/TR/2008/REC-xml-20081126/" target="_top">Extensible Markup Language (XML) 1.0 (Fifth
          Edition)</a>
      </em>. </span>
      <span class="author">T. Bray, et al. </span>
      <span class="date">26 November 2008. </span>
    </p></div></div><div class="bibliodiv" id="informative-refs">
    <h3 class="title">Informative References</h3>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
  <div class="biblioentry" id="refDOM2TraversalRange"><p>[<abbr class="abbrev">DOM2 Traversal Range</abbr>] 
      
      <span class="title"><em><a class="ulink" href="https://www.w3.org/TR/DOM-Level-2-Traversal-Range/ranges.html" target="_top">Document Object Model (DOM)
          Level 2 Traversal and Range Specification</a></em>. </span>
      <span class="author">Joe Kesselman, et al. </span>
      <span class="date">13 November, 2000. </span>
    </p></div><div class="biblioentry" id="refECMA262"><p>[<abbr class="abbrev">ECMA-262</abbr>] 
      
      <span class="title"><em><a class="ulink" href="http://www.ecma-international.org/ecma-262/6.0/" target="_top">ECMA-262 6th Edition, ECMAScript® 2015
          Language Specification</a></em>. </span>
      <span class="date">June 2015. </span>
    </p></div><div class="biblioentry" id="refFragIDBP"><p>[<abbr class="abbrev">FragIDBestPractices</abbr>] 
      
      <span class="title"><em><a class="ulink" href="https://www.w3.org/TR/fragid-best-practices/" target="_top">Best Practices for Fragment Identifiers and
          Media Type Definitions</a></em>. </span>
    </p></div><div class="biblioentry" id="refXPTRSH"><p>[<abbr class="abbrev">XPTRSH</abbr>] 
      
      <span class="title"><em>
        <a class="ulink" href="https://www.w3.org/TR/2003/REC-xptr-framework-20030325/" target="_top">XPointer Shorthand Notation</a>
      </em>. </span>
      <span class="date">25 March 2003. </span>
    </p></div></div></section>
  
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script></body></html>